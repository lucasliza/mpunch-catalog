<!DOCTYPE html>
<html lang="ptBr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-ocorrência de Temas - Melbourne Punch</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
    <style>
        :root {
            --primary-color: #3182ce;
            --secondary-color: #2d3748;
            --background-gradient: linear-gradient(135deg, #1e3a5f 0%, #2c5282 50%, #3182ce 100%);
            --card-background: rgba(255, 255, 255, 0.98);
            --border-color: #e2e8f0;
            --text-color-muted: #4a5568;
            --accent-color: #38b2ac;
        }

        body {
            margin: 0;
            padding: 2rem;
            background: var(--background-gradient);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--card-background);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #fff;
            padding: 2rem;
            text-align: center;
        }

        h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: #fff;
            background-color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background-color: #2c5282;
            transform: translateY(-2px);
        }

        .main-content {
            padding: 2rem;
        }

        /* Controles avançados */
        .advanced-controls {
            background: #f7fafc;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .controls-section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-label {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        select,
        input,
        button {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            font-weight: 500;
            cursor: pointer;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(49, 130, 206, 0.3);
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .button-group button {
            flex: 1;
            min-width: 120px;
        }

        .layout-button {
            background: #e2e8f0;
            color: var(--secondary-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layout-button.active {
            background: var(--primary-color);
            color: white;
        }

        /* Layout de visualização */
        .viz-layout {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 2rem;
            height: 800px;
        }

        .network-section {
            /* ... outras propriedades ... */
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Importante para flexbox */
        }

        #network-container {
            height: 600px;
            /* Altura fixa específica */
            width: 100%;
            position: relative;
            background: #fafafa;
        }

        .network-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .network-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .network-info {
            font-size: 0.9rem;
            color: var(--text-color-muted);
        }

        .network-controls {
            display: flex;
            gap: 0.5rem;
        }

        .zoom-control {
            background: var(--border-color);
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .zoom-control:hover {
            background: var(--primary-color);
            color: white;
        }

        #network-container {
            flex: 1;
            position: relative;
            background: #fafafa;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow: hidden;
        }

        .info-panel {
            background: #fff;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            display: contents;
            flex-direction: column;
        }

        .info-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .compact-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .compact-stat {
            text-align: center;
            padding: 0.5rem;
            background: #f7fafc;
            border-radius: 6px;
        }

        .compact-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .compact-stat-label {
            font-size: 0.7rem;
            color: var(--text-color-muted);
        }

        .theme-search {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .theme-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .theme-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.85rem;
        }

        .theme-item:hover {
            background-color: #f7fafc;
        }

        .theme-item.selected {
            background-color: #ebf8ff;
            border-left: 4px solid var(--primary-color);
        }

        .theme-item.highlighted {
            background-color: #fef5e7;
            border-left: 4px solid #ed8936;
        }

        .theme-name {
            font-weight: 500;
            color: var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .theme-count {
            background-color: var(--primary-color);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }

        /* Responsividade */
        @media (max-width: 1400px) {
            .viz-layout {
                grid-template-columns: 2fr 1fr;
                height: 700px;
            }
        }

        @media (max-width: 1000px) {
            .viz-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .network-section {
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>Co-ocorrência de Temas</h1>
            <p class="subtitle">Análise co-ocorrência de temas nas charges do Melbourne Punch (1855-1860)</p>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Página Inicial</a>
                <a href="charts.html" class="nav-link">Hub de Visualizações</a>
            </div>
        </header>

        <main class="main-content">
            <!-- Controles -->
            <div class="advanced-controls">
                <div class="controls-section">
                    <div class="section-title">Filtros</div>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label class="control-label">Ano:</label>
                            <select id="yearFilter">
                                <option value="all">Todos os Anos</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Formato:</label>
                            <select id="categoryFilter">
                                <option value="all">Todos os Formatos</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Assunto:</label>
                            <select id="topicFilter">
                                <option value="all">Todos os Assuntos</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Co-ocorrência Mínima:</label>
                            <input type="range" id="minCooccurrence" min="1" max="20" value="1">
                            <span id="minCooccurrenceValue">1</span>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Mostrar:</label>
                            <select id="topThemes">
                                <option value="all">Todos os Temas</option>
                                <option value="20">Top 20 Temas</option>
                                <option value="50">Top 50 Temas</option>
                                <option value="100">Top 100 Temas</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="controls-section">
                    <div class="section-title">Ações Rápidas</div>
                    <div class="button-group">
                        <button onclick="resetFilters()">🔄 Resetar</button>
                    </div>
                </div>
            </div>

            <!-- Layout de Visualização -->
            <div class="viz-layout">
                <!-- Rede Principal -->
                <div class="network-section">
                    <div class="network-header">
                        <div>
                            <div class="network-title">Rede de Co-ocorrência</div>
                            <div class="network-info" id="networkInfo">Carregando...</div>
                        </div>
                        <div class="network-controls">
                            <button class="zoom-control" onclick="zoomIn()">+</button>
                            <button class="zoom-control" onclick="zoomOut()">-</button>
                            <button class="zoom-control" onclick="fitNetwork()">⌂</button>
                        </div>
                    </div>
                    <div id="network-container">
                        <div class="loading-overlay" id="loadingOverlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Estatísticas -->
                    <div class="info-panel">
                        <div class="info-title">Estatísticas</div>
                        <div class="compact-stats">
                            <div class="compact-stat">
                                <div class="compact-stat-number" id="visibleThemes">-</div>
                                <div class="compact-stat-label">Temas Visíveis</div>
                            </div>
                            <div class="compact-stat">
                                <div class="compact-stat-number" id="visibleConnections">-</div>
                                <div class="compact-stat-label">Conexões</div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Temas -->
                    <div class="info-panel">
                        <div class="info-title">
                            Temas
                            <span id="themeCount">(0)</span>
                        </div>
                        <input type="text" class="theme-search" id="themeSearch" placeholder="Buscar tema...">
                        <div class="theme-list" id="themesList"></div>
                    </div>

                    <!-- Detalhes da Seleção -->
                    <div class="info-panel">
                        <div class="info-title">Detalhes</div>
                        <div id="selectionDetails">
                            <p style="color: var(--text-color-muted); text-align: center; font-size: 0.8rem;">
                                Selecione um tema na rede
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Variáveis globais
        let allCartoons = [];
        let network = null;
        let visData = null;
        let selectedTheme = null;
        let currentLayout = 'physics';

        // Cores para nós
        const colorPalette = [
            '#3182ce', '#38b2ac', '#9f7aea', '#ed8936', '#48bb78', '#e53e3e',
            '#d69e2e', '#38a169', '#319795', '#805ad5', '#dd6b20', '#c53030',
            '#0078ff', '#00d2ff', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4',
            '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
            '#10ac84', '#ee5253', '#0abde3', '#006ba6', '#a55eea', '#26de81'
        ];

        // Configuração otimizada para redes grandes
        const networkConfig = {
            physics: {
                enabled: true,
                barnesHut: {
                    gravitationalConstant: -2000,
                    centralGravity: 1,
                    springLength: 95,
                    springConstant: 0.04,
                    damping: 0.09,
                    avoidOverlap: 0.1
                },
                stabilization: {
                    enabled: true,
                }
            },
            nodes: {
                shape: 'dot',
                scaling: {
                    min: 8,
                    max: 80,
                    label: {
                        min: 8,
                        max: 16,
                        drawThreshold: 12,
                        maxVisible: 30
                    }
                },
                font: {
                    size: 12,
                    face: 'Segoe UI',
                    strokeWidth: 2,
                    strokeColor: '#ffffff'
                },
                borderWidth: 2
            },
            edges: {
                width: 0.5,
                color: {
                    color: '#848484',
                    highlight: '#3182ce'
                },
                smooth: {
                    enabled: true,
                    type: 'continuous',
                    roundness: 0.5
                },
                scaling: {
                    min: 1,
                    max: 10
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 300,
                hideEdgesOnDrag: true
            },
            layout: {
                improvedLayout: true,
            }
        };

        // Inicialização
        function loadCartoonData() {
            showLoading();

            fetch('./data/cartoons.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Carregados ${data.length} cartões`);
                    allCartoons = data;
                    initializeFilters();
                    updateVisualization();
                    hideLoading();
                })
                .catch(error => {
                    console.log('Erro ao carregar dados:', error.message);
                    initializeFilters();
                    updateVisualization();
                    hideLoading();
                });
        }

        function initializeFilters() {
            const years = [...new Set(allCartoons.map(item => item.year))].filter(Boolean).sort();
            const yearFilter = document.getElementById('yearFilter');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });

            const categories = [...new Set(allCartoons.map(item => item.category))].filter(Boolean).sort();
            const categoryFilter = document.getElementById('categoryFilter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            const topics = [...new Set(allCartoons.map(item => item.topic))].filter(Boolean).sort();
            const topicFilter = document.getElementById('topicFilter');
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicFilter.appendChild(option);
            });

            // Event listeners
            document.getElementById('yearFilter').addEventListener('change', updateVisualization);
            document.getElementById('categoryFilter').addEventListener('change', updateVisualization);
            document.getElementById('topicFilter').addEventListener('change', updateVisualization);
            document.getElementById('minCooccurrence').addEventListener('input', (e) => {
                document.getElementById('minCooccurrenceValue').textContent = e.target.value;
                updateVisualization();
            });
            document.getElementById('topThemes').addEventListener('change', updateVisualization);

            // Busca com debounce
            let searchTimeout;
            document.getElementById('themeSearch').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterThemesList(e.target.value);
                }, 300);
            });
        }

        function updateVisualization() {
            showLoading();

            setTimeout(() => {
                const filteredData = getFilteredData();
                const { themeCounts, themePairs } = processData(filteredData);

                renderNetwork(themeCounts, themePairs);
                updateSidebar(themeCounts, themePairs);
                updateStatistics(themeCounts, themePairs);
                hideLoading();
            }, 1000);
        }

        function getFilteredData() {
            const yearFilter = document.getElementById('yearFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const topicFilter = document.getElementById('topicFilter').value;
            const topThemes = document.getElementById('topThemes').value;

            let filtered = allCartoons.filter(cartoon => {
                const yearMatch = yearFilter === 'all' || cartoon.year == yearFilter;
                const categoryMatch = categoryFilter === 'all' || cartoon.category === categoryFilter;
                const topicMatch = topicFilter === 'all' || (cartoon.topic && cartoon.topic.includes(topicFilter));

                return yearMatch && categoryMatch && topicMatch && cartoon.themes && cartoon.themes.length > 0;
            });

            if (topThemes !== 'all') {
                const { themeCounts } = processData(filtered);
                const topThemeNames = Object.entries(themeCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, parseInt(topThemes))
                    .map(([theme]) => theme);

                filtered = filtered.filter(cartoon =>
                    cartoon.themes.some(theme => topThemeNames.includes(theme))
                );
            }

            return filtered;
        }

        function processData(data) {
            const themeCounts = {};
            const themePairs = {};

            data.forEach(cartoon => {
                if (cartoon.themes && cartoon.themes.length > 0) {
                    cartoon.themes.forEach(theme => {
                        themeCounts[theme] = (themeCounts[theme] || 0) + 1;
                    });

                    if (cartoon.themes.length > 1) {
                        for (let i = 0; i < cartoon.themes.length; i++) {
                            for (let j = i + 1; j < cartoon.themes.length; j++) {
                                const pair = [cartoon.themes[i], cartoon.themes[j]]
                                    .sort().join('|||');
                                themePairs[pair] = (themePairs[pair] || 0) + 1;
                            }
                        }
                    }
                }
            });

            return { themeCounts, themePairs };
        }

        function renderNetwork(themeCounts, themePairs) {
            const minCooccurrence = parseInt(document.getElementById('minCooccurrence').value);

            // Filtrar pares por co-ocorrência mínima
            const filteredPairs = Object.entries(themePairs)
                .filter(([pair, count]) => count >= minCooccurrence);

            // Obter temas conectados
            const connectedThemes = new Set();
            filteredPairs.forEach(([pair]) => {
                const [theme1, theme2] = pair.split('|||');
                connectedThemes.add(theme1);
                connectedThemes.add(theme2);
            });

            // Adicionar alguns temas isolados mais frequentes (se houver espaço)
            const isolatedThemes = Object.keys(themeCounts)
                .filter(theme => !connectedThemes.has(theme))
                .sort((a, b) => themeCounts[b] - themeCounts[a])
                .slice(0, 10); // Máximo 10 temas isolados

            isolatedThemes.forEach(theme => connectedThemes.add(theme));

            // Criar nós
            const nodes = Array.from(connectedThemes).map((theme, index) => {
                const count = themeCounts[theme] || 0;
                const connections = getThemeConnections(theme, filteredPairs);

                // Tamanho baseado em frequência e centralidade
                const size = Math.max(8, Math.max(40, count * 2 + connections.length * 3));

                return {
                    id: theme,
                    label: theme.length > 15 ? theme.substring(0, 12) + '...' : theme,
                    title: `${theme}\nOcorrências: ${count}\nConexões: ${connections.length}`,
                    value: size,
                    color: {
                        background: colorPalette[index % colorPalette.length],
                        border: colorPalette[index % colorPalette.length],
                        highlight: {
                            background: '#ff6b6b',
                            border: '#ff5252'
                        }
                    },
                    font: {
                        size: Math.max(10, Math.min(16, 8 + Math.floor(count / 2))),
                        color: '#2d3748'
                    },
                    mass: Math.max(1, count) // Massa para física
                };
            });

            // Criar arestas
            const edges = filteredPairs.map(([pair, count]) => {
                const [theme1, theme2] = pair.split('|||');
                const weight = Math.log(count + 1) * 2; // Log scale para melhor visualização

                return {
                    from: theme1,
                    to: theme2,
                    value: count,
                    title: `${theme1} ↔ ${theme2}\nCo-ocorrências: ${count}`,
                    width: Math.max(0.5, weight),
                    color: {
                        color: getEdgeColor(count, Math.max(...Object.values(themePairs))),
                        highlight: '#3182ce'
                    },
                    length: Math.max(50, 200 - count * 10), // Conexões mais fortes = mais curtas
                    smooth: {
                        enabled: true,
                        type: 'continuous',
                        roundness: 0.5
                    }
                };
            });

            // Atualizar dados da visualização
            visData = {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            };

            // Configurar opções da rede
            const options = { ...networkConfig };

            // Criar ou atualizar rede
            const container = document.getElementById('network-container');
            if (network) {
                network.destroy();
            }
            network = new vis.Network(container, visData, options);

            // Event listeners otimizados
            network.on('selectNode', (params) => {
                if (params.nodes.length > 0) {
                    selectedTheme = params.nodes[0];
                    updateSelectionDetails(selectedTheme, themePairs);
                    highlightThemeInList(selectedTheme);
                }
            });

            network.on('deselectNode', () => {
                selectedTheme = null;
                clearSelectionDetails();
                clearThemeHighlight();
            });

            network.on('doubleClick', (params) => {
                if (params.nodes.length > 0) {
                    focusOnTheme(params.nodes[0]);
                }
            });

            network.once('stabilizationIterationsDone', () => {
                console.log('Rede estabilizada - desabilitando física');
                network.setOptions({ physics: false });
                updateNetworkInfo();
            });

            // Adicionar timeout como backup caso a estabilização não seja detectada
            setTimeout(() => {
                if (network) {
                    console.log('Forçando desabilitação da física após 5 segundos');
                    network.setOptions({ physics: false });
                }
            }, 5000);

            // Controle de zoom
            network.on('zoom', () => {
                updateZoomInfo();
            });
        }

        // Funções auxiliares para renderização
        function getThemeConnections(theme, filteredPairs) {
            return filteredPairs.filter(([pair]) => {
                const [theme1, theme2] = pair.split('|||');
                return theme1 === theme || theme2 === theme;
            });
        }

        function getEdgeColor(count, maxCount) {
            const intensity = count / maxCount;
            if (intensity > 0.8) return '#2d3748';
            if (intensity > 0.5) return '#4a5568';
            if (intensity > 0.2) return '#718096';
            return '#a0aec0';
        }

        function updateSidebar(themeCounts, themePairs) {
            updateThemesList(themeCounts);
        }

        function updateThemesList(themeCounts) {
            const themesList = document.getElementById('themesList');
            themesList.innerHTML = '';

            const sortedThemes = Object.entries(themeCounts)
                .sort(([, a], [, b]) => b - a);

            document.getElementById('themeCount').textContent = `(${sortedThemes.length})`;

            sortedThemes.forEach(([theme, count]) => {
                const item = document.createElement('div');
                item.className = 'theme-item';
                item.onclick = () => focusOnTheme(theme);

                item.innerHTML = `
                    <span class="theme-name" title="${theme}">${theme}</span>
                    <span class="theme-count">${count}</span>
                `;

                themesList.appendChild(item);
            });
        }

        function filterThemesList(searchTerm) {
            const items = document.querySelectorAll('.theme-item');
            let visibleCount = 0;

            items.forEach(item => {
                const themeName = item.querySelector('.theme-name').textContent.toLowerCase();
                const matches = searchTerm === '' || themeName.includes(searchTerm.toLowerCase());

                item.style.display = matches ? 'flex' : 'none';
                if (matches) {
                    visibleCount++;
                    if (searchTerm) {
                        item.classList.add('highlighted');
                    } else {
                        item.classList.remove('highlighted');
                    }
                }
            });

            if (searchTerm) {
                document.getElementById('themeCount').textContent = `(${visibleCount} encontrados)`;
            }
        }

        function updateStatistics(themeCounts, themePairs) {
            const totalThemes = Object.keys(themeCounts).length;
            const totalConnections = Object.keys(themePairs).length;

            const connectionValues = Object.values(themePairs);
            const strongestConnection = Math.max(...connectionValues, 0);

            const maxPossibleConnections = (totalThemes * (totalThemes - 1)) / 2;
            const density = maxPossibleConnections > 0 ?
                ((totalConnections / maxPossibleConnections) * 100).toFixed(1) + '%' : '0%';

            document.getElementById('visibleThemes').textContent = totalThemes;
            document.getElementById('visibleConnections').textContent = totalConnections;
        }

        function updateSelectionDetails(themeName, themePairs) {
            const connections = [];

            Object.entries(themePairs).forEach(([pair, count]) => {
                const [theme1, theme2] = pair.split('|||');
                if (theme1 === themeName || theme2 === themeName) {
                    const otherTheme = theme1 === themeName ? theme2 : theme1;
                    connections.push({ theme: otherTheme, count });
                }
            });

            connections.sort((a, b) => b.count - a.count);

            const detailsContainer = document.getElementById('selectionDetails');
            detailsContainer.innerHTML = '';

            if (connections.length === 0) {
                detailsContainer.innerHTML = `
                    <div style="text-align: center; color: var(--text-color-muted); font-size: 0.8rem;">
                        <strong>${themeName}</strong><br/>
                        Tema isolado (sem conexões)
                    </div>
                `;
                return;
            }

            const title = document.createElement('div');
            title.innerHTML = `<strong style="font-size: 0.9rem;">${themeName}</strong>`;
            title.style.marginBottom = '0.5rem';
            detailsContainer.appendChild(title);

            const connectionsDiv = document.createElement('div');
            connections.slice(0, 6).forEach(({ theme, count }) => {
                const item = document.createElement('div');
                item.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 0.3rem;
                    margin-bottom: 0.3rem;
                    background: #f7fafc;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.8rem;
                `;

                item.innerHTML = `
                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;" title="${theme}">${theme}</span>
                    <span style="background: var(--accent-color); color: white; padding: 0.1rem 0.3rem; border-radius: 8px; font-size: 0.7rem;">${count}</span>
                `;
                item.onclick = () => focusOnTheme(theme);
                connectionsDiv.appendChild(item);
            });

            detailsContainer.appendChild(connectionsDiv);

            if (connections.length > 6) {
                const moreInfo = document.createElement('div');
                moreInfo.style.cssText = 'text-align: center; color: var(--text-color-muted); font-size: 0.7rem; margin-top: 0.5rem;';
                moreInfo.textContent = `+${connections.length - 6} outras conexões`;
                detailsContainer.appendChild(moreInfo);
            }
        }

        function clearSelectionDetails() {
            document.getElementById('selectionDetails').innerHTML = `
                <p style="color: var(--text-color-muted); text-align: center; font-size: 0.8rem;">
                    Selecione um tema na rede
                </p>
            `;
        }

        // Controles de layout
        function setNetworkLayout(layoutType) {
            currentLayout = layoutType;

            document.querySelectorAll('.layout-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            updateVisualization();
        }

        // Funções de navegação
        function focusOnTheme(themeName) {
            if (network && visData && visData.nodes.get(themeName)) {
                network.selectNodes([themeName]);
                network.focus(themeName, {
                    scale: 1.5,
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }
        }

        function zoomIn() {
            if (network) {
                const scale = network.getScale() * 1.2;
                network.moveTo({ scale });
            }
        }

        function zoomOut() {
            if (network) {
                const scale = network.getScale() * 0.8;
                network.moveTo({ scale });
            }
        }

        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }
        }

        function focusOnHubs() {
            const filteredData = getFilteredData();
            const { themeCounts } = processData(filteredData);

            const hubs = Object.entries(themeCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5)
                .map(([theme]) => theme);

            if (network && hubs.length > 0) {
                network.selectNodes(hubs);
                network.fit({
                    nodes: hubs,
                    animation: { duration: 1000 }
                });
            }
        }

        function showWeakConnections() {
            document.getElementById('minCooccurrence').value = 1;
            document.getElementById('minCooccurrenceValue').textContent = '1';
            updateVisualization();
        }

        function resetFilters() {
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('topicFilter').value = 'all';
            document.getElementById('minCooccurrence').value = 1;
            document.getElementById('minCooccurrenceValue').textContent = '1';
            document.getElementById('topThemes').value = 'all';
            document.getElementById('themeSearch').value = '';

            currentLayout = 'physics';

            document.querySelectorAll('.layout-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.layout-button').classList.add('active');

            updateVisualization();
        }

        // Funções auxiliares
        function calculateNetworkDensity(themeCounts, themePairs) {
            const totalThemes = Object.keys(themeCounts).length;
            const totalConnections = Object.keys(themePairs).length;
            const maxPossibleConnections = (totalThemes * (totalThemes - 1)) / 2;

            return maxPossibleConnections > 0 ?
                (totalConnections / maxPossibleConnections * 100).toFixed(2) + '%' : '0%';
        }

        function calculateAverageConnections(themeCounts, themePairs) {
            const connectionCounts = {};

            Object.entries(themePairs).forEach(([pair, count]) => {
                const [theme1, theme2] = pair.split('|||');
                connectionCounts[theme1] = (connectionCounts[theme1] || 0) + 1;
                connectionCounts[theme2] = (connectionCounts[theme2] || 0) + 1;
            });

            const values = Object.values(connectionCounts);
            return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : 0;
        }

        function getMostConnectedThemes(themeCounts, themePairs, limit) {
            const connectionCounts = {};

            Object.entries(themePairs).forEach(([pair, count]) => {
                const [theme1, theme2] = pair.split('|||');
                connectionCounts[theme1] = (connectionCounts[theme1] || 0) + 1;
                connectionCounts[theme2] = (connectionCounts[theme2] || 0) + 1;
            });

            return Object.entries(connectionCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, limit)
                .map(([theme, connections]) => ({ theme, connections }));
        }

        function highlightThemeInList(themeName) {
            document.querySelectorAll('.theme-item').forEach(item => {
                item.classList.remove('selected');
                if (item.querySelector('.theme-name').textContent === themeName) {
                    item.classList.add('selected');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        function clearThemeHighlight() {
            document.querySelectorAll('.theme-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function updateNetworkInfo() {
            const nodeCount = visData ? visData.nodes.length : 0;
            const edgeCount = visData ? visData.edges.length : 0;
            document.getElementById('networkInfo').textContent =
                `${nodeCount} nós, ${edgeCount} arestas`;
        }

        function updateZoomInfo() {
            if (network) {
                const scale = network.getScale();
                // Opcional: mostrar nível de zoom em algum lugar da interface
                // console.log(`Zoom level: ${scale.toFixed(2)}`);
            }
        }

        function showLoading() {

        }

        function hideLoading() {

        }

        // Inicializar quando DOM carregar
        document.addEventListener('DOMContentLoaded', loadCartoonData);
    </script>

</body>

</html>